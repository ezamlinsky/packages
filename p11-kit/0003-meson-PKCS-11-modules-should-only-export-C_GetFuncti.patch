From 7d4768712006b16856c4b8cbe7143d11c11def7f Mon Sep 17 00:00:00 2001
From: "Jan Alexander Steffens (heftig)" <jan.steffens@gmail.com>
Date: Tue, 10 Sep 2019 18:08:25 +0000
Subject: [PATCH 3/8] meson: PKCS#11 modules should only export
 C_GetFunctionList

---
 p11-kit/meson.build    | 10 ++++++++++
 p11-kit/p11-module.def |  2 ++
 p11-kit/p11-module.map |  6 ++++++
 trust/meson.build      |  6 +++++-
 4 files changed, 23 insertions(+), 1 deletion(-)
 create mode 100644 p11-kit/p11-module.def
 create mode 100644 p11-kit/p11-module.map

diff --git a/p11-kit/meson.build b/p11-kit/meson.build
index beb0fb2..e2d807b 100644
--- a/p11-kit/meson.build
+++ b/p11-kit/meson.build
@@ -81,12 +81,22 @@ meson.add_install_script(
   datadir / 'p11-kit' / 'modules'
 )
 
+p11_module_symbol_map = meson.current_source_dir() / 'p11-module.map'
+p11_module_ldflags = cc.get_supported_link_arguments([
+  '-Wl,--version-script,' + p11_module_symbol_map
+])
+p11_module_symbol_def = meson.current_source_dir() / 'p11-module.def'
+
 if host_system != 'windows'
   shared_module('p11-kit-client',
                 'client.c', 'client-init.c',
                 name_prefix: '',
                 include_directories: [configinc, commoninc],
+                link_args: p11_module_ldflags,
+                link_depends: [p11_module_symbol_map,
+                               p11_module_symbol_def],
                 link_with: [libp11_kit_internal],
+                vs_module_defs: p11_module_symbol_def,
                 install: true,
                 install_dir: p11_module_path)
 endif
diff --git a/p11-kit/p11-module.def b/p11-kit/p11-module.def
new file mode 100644
index 0000000..c4a8158
--- /dev/null
+++ b/p11-kit/p11-module.def
@@ -0,0 +1,2 @@
+EXPORTS
+C_GetFunctionList
diff --git a/p11-kit/p11-module.map b/p11-kit/p11-module.map
new file mode 100644
index 0000000..8b9c384
--- /dev/null
+++ b/p11-kit/p11-module.map
@@ -0,0 +1,6 @@
+{
+	global:
+		C_GetFunctionList;
+	local:
+		*;
+};
diff --git a/trust/meson.build b/trust/meson.build
index b6cb260..c5b978b 100644
--- a/trust/meson.build
+++ b/trust/meson.build
@@ -48,9 +48,13 @@ shared_module('p11-kit-trust',
               libtrust_sources,
               'module-init.c',
               name_prefix: '',
-	      c_args: p11_kit_trust_c_args,
+              c_args: p11_kit_trust_c_args,
               dependencies: [libp11_library_dep] + libtasn1_deps,
+              link_args: p11_module_ldflags,
+              link_depends: [p11_module_symbol_map,
+                             p11_module_symbol_def],
               link_with: libtrust_data,
+              vs_module_defs: p11_module_symbol_def,
               install: true,
               install_dir: prefix / p11_module_path)
 
-- 
2.23.0

